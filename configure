#! /usr/bin/perl -w
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# GENIE configuration script
#
# For help, type ./configure --help
#
# C.Andreopoulos <C.V.Andreopoulos@rl.ac.uk>, Rutherford Lab.
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# print out info & exit if any of the command-line arguments was --help
#
if(($match = grep(/--help/i, @ARGV)) > 0) { 
  print "\n";
  print "*** GENIE configure script *** \n\n";
  print "Usage: ./configure [option]... [flag=value]... \n\n";
  print "    FLAG            DESCRIPTION                                                         DEFAULT\n\n";
  print "    --prefix        installation location (for 'make install')                          /usr/local/\n\n";
  print "enable/disable options with either --enable- or --disable- (eg --enable-gibuu --disable-flux-drivers)\n\n";
  print "    profiler        GENIE code profiling using Google perftools                         default: disabled \n";
  print "    doxygen-doc     Generate doxygen documentation at build time                        default: disabled \n";
  print "    nuvalidator     GENIE's NuValidator tool, requires MySQL                            default: disabled \n";
  print "    neugen          GENIE/NeuGEN facade, requires libneugen3.a                          default: disabled \n";
  print "    neut-cascade    Alternative intranuclear hadron transport MC, requires libNEUT.a    default: disabled \n";
  print "    gibuu           Alternative intranuclear hadron transport MC, requires libGiBUU.a   default: disabled \n";
  print "    lhapdf          Use the LHAPDF pdf library                                          default: disabled \n";
  print "    flux-drivers    Built-in flux drivers                                               default: enabled  \n";
  print "    geom-drivers    Built-in detector geometry drivers                                  default: enabled  \n";
  print "    test            Build test programs                                                 default: disabled \n";
  print "    viewer          Event generation GUI _incomplete_                                   default: disabled \n";
  print "    mueloss         Muon energy loss modeling                                           default: enabled  \n";
  print "    dylibversion    Adds version number in dynamic lib names [recommended]              default: enabled  \n";
  print "    minos-evserv    GENIE event server for interfacing to GMINOS                        default: disabled \n";
  print "    lowlevel-mesg   Disable (rather that expecting the mesg service to filter out)      default: disabled \n";
  print "                    certain copious debug/info messages known to slow GENIE down        \n";
  print "    debug           Adds -g in the compiler options to request debug info               default: disabled \n\n";
  print "with options for 3rd party software, prefix with --with- (eg --with-gibuu-lib=/some/path/libGiBUU.a)\n\n";
  print "    optimiz-level   compiler opitimization level O/O2/O3/OO/Os    default: O2 \n";
  print "    profiler-lib    Path to libprofiler.so library                if you --enable-profiler \n";
  print "    doxygen         Doxygen binary including full path            if you --enable-doxygen       / can pick \$DOXYGEN     \n";
  print "    neugen3path     NeuGEN top level directory                    if you --enable-neugen        / can pick \$NEUGEN3PATH \n";
  print "    neut-lib        Path to libNEUT.a library                     if you --enable-neut-cascade  / can pick \$NEUT_LIB    \n";
  print "    gibuu-lib       Path to libGiBUU.a library                    if you --enable-gibuu         / can pick \$GIBUU_LIB   \n";
  print "    lhapdf-lib      Path to LHAPDF library                        if you --enable-lhapdf \n";
  print "    pythia6         PYTHIA6 library path                          always needed / can pick \$PYTHIA6 / auto-detected \n";
  print "    cernlib         CERN libraries path                           always needed / can pick \$CERNLIB / auto-detected \n";
  print "    libxml2-inc     Path to libxml2 includes                      always needed / auto-detected \n";
  print "    libxml2-lib     Path to libxml2 library                       always needed / auto-detected \n";
  print "    log4cpp-inc     Path to log4cpp includes                      always needed / auto-detected \n";
  print "    log4cpp-lib     Path to log4cpp library                       always needed / auto-detected \n\n";
  exit 0;
}

# Check that $GENIE is set
#
$GENIE = $ENV{'GENIE'};
die ("*** Error *** The GENIE environmental variable (pointing to the top level GENIE directory) is not defined") 
unless defined $GENIE;

# Check that $ROOTSYS is set
#
$ROOTSYS = $ENV{'ROOTSYS'};
die ("*** Error *** The ROOTSYS environmental variable is not defined. Is ROOT installed?") 
unless defined $ROOTSYS;

# Print GENIE banner 
#
$BANNER_FILE = "$GENIE/data/banner/BANNER.txt";
if(-e $BANNER_FILE) {
  open(BANNER, "<$BANNER_FILE");
  @hdr=<BANNER>;
  print @hdr;
  close(BANNER);
}

# Enable auto-detection?
#
system("find $GENIE/configure");
print "\n";
$auto_detect = ($?==0) ? 1 : 0;
if(! $auto_detect) {
     print "\n*** Warn *** Path auto-detection is turned off. You need the 'find' utility to use that feature\n\n";
}

# Open Make.config to write configuration options
#
$MKCONF_FILE = "$GENIE/src/make/Make.config";
open(MKCONF, ">$MKCONF_FILE") or die("Can not write out the Make.config file!");

print MKCONF "# \n";
print MKCONF "# Make.config \n";
print MKCONF "# This file was automatically generated by the 'configure' script  \n";
print MKCONF "# and is included into the project Makefiles  \n";
print MKCONF "# \n";

# Create a string by joining all the command line arguments
#
my $options = join(" ", @ARGV);

# Get & save installation location (--prefix) or set default
#
my $prefix="/usr/local/";
if(($match = grep(/--prefix/i, @ARGV)) > 0) { 
  $options=~m/--prefix=(\S*)/i;
  $prefix = $1;
  if( $GENIE eq $prefix ) {
     print "*** Error *** --prefix can not point to the GENIE top level directory!\n\n";
     exit 1;
  }
}
print MKCONF "GENIE_INSTALLATION_PATH=$prefix\n";

# Default --enable/--disable config options (for a minimal genie build)
#
my $gopt_enable_profiler      = "NO";
my $gopt_enable_nuvalidator   = "NO";
my $gopt_enable_neugen        = "NO";
my $gopt_enable_neut_cascade  = "NO";
my $gopt_enable_gibuu         = "NO";
my $gopt_enable_lhapdf        = "NO";
my $gopt_enable_flux_drivers  = "YES";
my $gopt_enable_geom_drivers  = "YES";
my $gopt_enable_doxygen_doc   = "NO";
my $gopt_enable_test          = "NO";
my $gopt_enable_viewer        = "NO";
my $gopt_enable_mueloss       = "YES";
my $gopt_enable_dylibversion  = "YES";
my $gopt_enable_minos_evserv  = "NO";
my $gopt_enable_lowlevel_mesg = "NO";
my $gopt_enable_debug         = "NO";

# Check configure's command line arguments for non-default values
#
if(($match = grep(/--enable-profiler/i,      @ARGV)) > 0) { $gopt_enable_profiler      = "YES"; }
if(($match = grep(/--enable-doxygen-doc/i,   @ARGV)) > 0) { $gopt_enable_doxygen_doc   = "YES"; }
if(($match = grep(/--enable-nuvalidator/i,   @ARGV)) > 0) { $gopt_enable_nuvalidator   = "YES"; }
if(($match = grep(/--enable-neugen/i,        @ARGV)) > 0) { $gopt_enable_neugen        = "YES"; }
if(($match = grep(/--enable-neut-cascade/i,  @ARGV)) > 0) { $gopt_enable_neut_cascade  = "YES"; }
if(($match = grep(/--enable-gibuu/i,         @ARGV)) > 0) { $gopt_enable_gibuu         = "YES"; }
if(($match = grep(/--enable-lhapdf/i,        @ARGV)) > 0) { $gopt_enable_lhapdf        = "YES"; }
if(($match = grep(/--enable-test/i,          @ARGV)) > 0) { $gopt_enable_test          = "YES"; }
if(($match = grep(/--enable-viewer/i,        @ARGV)) > 0) { $gopt_enable_viewer        = "YES"; }
if(($match = grep(/--enable-minos-evserv/i,  @ARGV)) > 0) { $gopt_enable_minos_evserv  = "YES"; }
if(($match = grep(/--enable-lowlevel-mesg/i, @ARGV)) > 0) { $gopt_enable_lowlevel_mesg = "YES"; }
if(($match = grep(/--enable-debug/i,         @ARGV)) > 0) { $gopt_enable_debug         = "YES"; }
if(($match = grep(/--disable-flux-drivers/i, @ARGV)) > 0) { $gopt_enable_flux_drivers  = "NO";  }
if(($match = grep(/--disable-geom-drivers/i, @ARGV)) > 0) { $gopt_enable_geom_drivers  = "NO";  }
if(($match = grep(/--disable-mueloss/i,      @ARGV)) > 0) { $gopt_enable_mueloss       = "NO";  }
if(($match = grep(/--disable-dylibversion/i, @ARGV)) > 0) { $gopt_enable_dylibversion  = "NO";  }

my $gopt_cxx_debug_flag="";
if($gopt_enable_debug eq "YES") { $gopt_cxx_debug_flag = "-g"; }

# Save config options
#
print MKCONF "GOPT_ENABLE_PROFILER=$gopt_enable_profiler\n";
print MKCONF "GOPT_ENABLE_DOXYGEN_DOC=$gopt_enable_doxygen_doc\n"; 
print MKCONF "GOPT_ENABLE_NUVALIDATOR=$gopt_enable_nuvalidator\n"; 
print MKCONF "GOPT_ENABLE_NEUGEN=$gopt_enable_neugen\n";
print MKCONF "GOPT_ENABLE_NEUT_CASCADE=$gopt_enable_neut_cascade\n";
print MKCONF "GOPT_ENABLE_GIBUU=$gopt_enable_gibuu\n";
print MKCONF "GOPT_ENABLE_LHAPDF=$gopt_enable_lhapdf\n";
print MKCONF "GOPT_ENABLE_FLUX_DRIVERS=$gopt_enable_flux_drivers\n";
print MKCONF "GOPT_ENABLE_GEOM_DRIVERS=$gopt_enable_geom_drivers\n";
print MKCONF "GOPT_ENABLE_TEST=$gopt_enable_test\n";
print MKCONF "GOPT_ENABLE_VIEWER=$gopt_enable_viewer\n";
print MKCONF "GOPT_ENABLE_MUELOSS=$gopt_enable_mueloss\n";
print MKCONF "GOPT_ENABLE_DYLIBVERSION=$gopt_enable_dylibversion\n";
print MKCONF "GOPT_ENABLE_MINOS_EVENT_SERVER=$gopt_enable_minos_evserv\n";
print MKCONF "GOPT_ENABLE_LOW_LEVEL_MESG=$gopt_enable_lowlevel_mesg\n";
print MKCONF "GOPT_CXX_DEBUG_FLAG=$gopt_cxx_debug_flag\n";

# Check for --with options:

# Check compiler optimization level
#
my $gopt_cxx_optimiz_flag="O2"; # default
if( $options=~m/--with-optimiz-level=(\S*)/i ) {
  $gopt_cxx_optimiz_flag = $1;
}

# If --enable-profiler was set then the full path to the profiler library must be specified
#
my $gprofiler_lib = "";
if($gopt_enable_profiler eq "YES") {
  if(($match = grep(/--with-profiler-lib/i, @ARGV)) > 0) { 
    $options=~m/--with-profiler-lib=(\S*)/i;
    $gprofiler_lib = $1;
  }
}

# If --enable-doxygen was set then the full path to the doxygen binary must be specified
# unless it is in the $PATH
#
my $doxygen = "";
if($gopt_enable_doxygen_doc eq "YES") {
  if(($match = grep(/--with-doxygen/i, @ARGV)) > 0) { 
    $options=~m/--with-doxygen=(\S*)/i;
    $doxygen = $1;
  }
  # if it was not set, try to pick it up from the environment
  if(! -f $doxygen && defined $ENV{'DOXYGEN'}) { $doxygen = $ENV{'DOXYGEN'}; }
  # complain
  if(! -f $doxygen) {
     print "*** Error *** You need to specify the path to doxygen using --with-doxygen=/some/path/\n";
     print "*** Error *** Otherwise, you should --disable-doxygen-doc\n\n";
     exit 1;
  }
}

# If --enable-neugen was set then the location to the neugen installation must be specified
#
my $neugen3path = "";
if($gopt_enable_neugen eq "YES") {
  if(($match = grep(/--with-neugen3path/i, @ARGV)) > 0) { 
    $options=~m/--with-neugen3path=(\S*)/i;
    $neugen3path = $1;
  }
  # if it was not set, try to pick it up from the environment
  if($neugen3path eq "" && defined $ENV{'NEUGEN3PATH'}) { $neugen3path = $ENV{'NEUGEN3PATH'}; }
  # check
  my $file = "$neugen3path/lib/libneugen3.a";
  if(! -e $file) {
     print "*** Error *** You need to specify the top level neugen3 directory using --with-neugen3path=/some/path/\n";
     print "*** Error *** Otherwise, you should --disable-neugen\n\n";
     exit 1;
  }
}

# If --enable-neut-cascade was set then the full path to the libNEUT.a library must be specified
#
my $neut_lib = "";
if($gopt_enable_neut_cascade eq "YES") {
  if(($match = grep(/--with-neut-lib/i, @ARGV)) > 0) { 
    $options=~m/--with-neut-lib=(\S*)/i;
    $neut_lib = $1;
  }
  # if it was not set, try to pick it up from the environment
  if($neut_lib eq "" && defined $ENV{'NEUT_LIB'}) { $neut_lib = $ENV{'NEUT_LIB'}; }
  # check
  my $file = "$neut_lib/libNEUT.a";
  if(! -e $file) {
     print "*** Error *** You need to specify the path to the libNEUT.a library using --with-neut-lib=/some/path/\n";
     print "*** Error *** Otherwise, you should --disable-neut-cascade\n\n";
     exit 1;
  }
}

# If --enable-gibuu was set then the full path to the libGiBUU.a library must be specified
#
my $gibuu_lib = "";
if($gopt_enable_gibuu eq "YES") {
  if(($match = grep(/--with-gibuu-lib/i, @ARGV)) > 0) { 
    $options=~m/--with-gibuu-lib=(\S*)/i;
    $gibuu_lib = $1;
  }
  # if it was not set, try to pick it up from the environment
  if($gibuu_lib eq "" && defined $ENV{'GIBUU_LIB'}) { $gibuu_lib = $ENV{'GIBUU_LIB'}; }
  # check
  my $file = "$gibuu_lib/libGiBUU.a";
  if(! -e $file) {
     print "*** Error *** You need to specify the path to the libGiBUU.a library using --with-gibuu-lib=/some/path/\n";
     print "*** Error *** Otherwise, you should --disable-gibuu\n\n";
     exit 1;
  }
}

# If --enable-lhapdf was set then the full path to the LHAPDF library must be specified
#
my $lhapdf_lib = "";
if($gopt_enable_lhapdf eq "YES") {
  if(($match = grep(/--with-lhapdf-lib/i, @ARGV)) > 0) { 
    $options=~m/--with-lhapdf-lib=(\S*)/i;
    $lhapdf_lib = $1;
  }
  # if it was not set, try to pick it up from the environment
  if($lhapdf_lib eq "" && defined $ENV{'LHAPDF_LIB'}) { $lhapdf_lib = $ENV{'LHAPDF_LIB'}; }
  # check
  my $file = "$lhapdf_lib/libLHAPDF.so";
  if(! -e $file) {
     print "*** Error *** You need to specify the path to the libLHAPDF.so library using --with-lhapdf-lib=/some/path/\n";
     print "*** Error *** Otherwise, you should --disable-lhapdf\n\n";
     exit 1;
  }
}

# If --enable-nuvalidator was set then ROOT must have mysql support enabled
#
if($gopt_enable_nuvalidator eq "YES") {

}

# Get PYTHIA6 and CERNLIB

my $pythia6 = "";
my $cernlib = "";

#
# --with-pythia6=
#
if($options=~m/--with-pythia6=(\S*)/i) {
  $pythia6 = $1;
} else {
  print "*** Warn *** You didn't specify the PYTHIA6 path \n";
}
# if it was not set, try to pick it up from the environment
if(! -d $pythia6 && defined $ENV{'PYTHIA6'}) { 
  $pythia6 = $ENV{'PYTHIA6'}; 
  print "The \$PYTHIA6 env var is defined. I will pick that and set --with-pythia6=$pythia6\n";
}
# if it still not set, try autodetecting it
if(! -d $pythia6 && $auto_detect) 
{
  print "Autodetecting the PYTHIA6 path...\n";
  $matched = auto_detect("libPythia6*");
  if( $matched=~m/(\S*)\/libPythia6\S*/i ) {
     $pythia6 = $1;
  }
  print "Setting --with-pythia6=$pythia6\n";
}
if(! -d $pythia6) {
    print "*** Error *** Could not locate the PYTHIA6 library path. Please specify it using --with-pythia6=/some/path/\n\n";
    exit 1;
} 

#
# --with-cernlib=
#
if($options=~m/--with-cernlib=(\S*)/i) {
  $cernlib = $1;
}
# if it was not set, try to pick it up from the environment
if(! -d $cernlib && defined $ENV{'CERNLIB'}) { 
  $cernlib = $ENV{'CERNLIB'}; 
  print "*** Warn *** You didn't specify the CERNLIB path \n";
  print "The \$CERNLIB env var is defined. I will pick that and use --with-cernlib=$cernlib\n";
}
# if it still not set, try autodetecting it
if(! -d $cernlib && $auto_detect) 
{
  print "Autodetecting the CERNLIB path...\n";
  $matched = auto_detect("libpdflib*.*");
  if( $matched=~m/(\S*)\/libpdflib\S*/i ) {
     $cernlib = $1;
  }
  print "Setting --with-cernlib=$cernlib\n";
}
if(! -d $cernlib) {
    print "*** Error *** Could not locate the CERNLIB path. Please specify it using --with-cernlb=/some/path/\n\n";
    exit 1;
}

# Get libxml2 and log4cpp include and library paths 

my $libxml2_inc = "";
my $libxml2_lib = "";
my $log4cpp_inc = "";
my $log4cpp_lib = "";

#
# --with-libxml2-inc=
#
if($options=~m/--with-libxml2-inc=(\S*)/i) {
  $libxml2_inc = $1;
}
if(! -d $libxml2_inc && $auto_detect)  {
  print "*** Warn *** You didn't specify the libxml2 include path \n";
  print "Autodetecting...\n";
  $matched = auto_detect("xmlmemory.h");
  if( $matched=~m/(\S*)\/libxml\/xmlmemory.h/i ) {
     $libxml2_inc = $1;
  }
  print "Setting --with-libxml2-inc=$libxml2_inc\n";
}
if(! -d $libxml2_inc) {
  print "*** Error *** You need to specify the libxml2 include path using --with-libxml2-inc=/some/path/\n\n";
  exit 1;
}

#
# --with-libxml2-lib=
#
if($options=~m/--with-libxml2-lib=(\S*)/i) {
  $libxml2_lib = $1;
}
if(! -d $libxml2_lib && $auto_detect)  {
  print "*** Warn *** You didn't specify the libxml2 library path \n";
  print "Autodetecting...\n";
  $matched = auto_detect("libxml2.*");
  if( $matched=~m/(\S*)\/libxml2\S*/i ) {
     $libxml2_lib = $1;
  }
  print "Setting --with-libxml2-lib=$libxml2_lib\n";
}
if(! -d $libxml2_lib) {
  print "*** Error *** You need to specify the libxml2 library path using --with-libxml2-lib=/some/path/\n\n";
  exit 1;
}

#
# --with-log4cpp-inc=
#
if($options=~m/--with-log4cpp-inc=(\S*)/i) {
  $log4cpp_inc = $1;
}
if(! -d $log4cpp_inc && $auto_detect)  {
  print "*** Warn *** You didn't specify the log4cpp include path \n";
  print "Autodetecting...\n";
  $matched = auto_detect("OstreamAppender.hh");
  if( $matched=~m/(\S*)\/log4cpp\/OstreamAppender.hh/i ) {
     $log4cpp_inc = $1;
  }
  print "Setting --with-log4cpp-inc=$log4cpp_inc\n";
}
if(! -d $log4cpp_inc) {
  print "*** Error *** You need to specify the log4cpp include path using --with-log4cpp-inc=/some/path/\n\n";
  exit 1;
}

#
# --with-log4cpp-lib=
#
if($options=~m/--with-log4cpp-lib=(\S*)/i) {
  $log4cpp_lib = $1;
}
if(! -d $log4cpp_lib && $auto_detect)  {
  print "*** Warn *** You didn't specify the log4cpp library path \n";
  print "Autodetecting...\n";
  $matched = auto_detect("liblog4cpp.*");
  if( $matched=~m/(\S*)\/liblog4cpp\S*/i ) {
     $log4cpp_lib = $1;
  }
  print "Setting --with-log4cpp-lib=$log4cpp_lib\n";
}
if(! -d $log4cpp_lib) {
  print "*** Error *** You need to specify the log4cpp library path using --with-log4cpp-lib=/some/path/\n\n";
  exit 1;
}

# Save the --with options
#
print MKCONF "GOPT_CXX_OPTIMIZ_FLAG=-$gopt_cxx_optimiz_flag\n";
print MKCONF "GPROFILER_LIB=$gprofiler_lib\n";
print MKCONF "NEUGEN3PATH=$neugen3path\n";
print MKCONF "NEUT_LIB=$neut_lib\n";
print MKCONF "GIBUU_LIB=$gibuu_lib\n";
print MKCONF "DOXYGEN=$doxygen\n";
print MKCONF "CERNLIB=$cernlib\n";
print MKCONF "PYTHIA6=$pythia6\n";
print MKCONF "LIBXML2_INC=$libxml2_inc\n";
print MKCONF "LIBXML2_LIB=$libxml2_lib\n";
print MKCONF "LOG4CPP_INC=$log4cpp_inc\n";
print MKCONF "LOG4CPP_LIB=$log4cpp_lib\n";

close(MKCONF);

print "\nYour input configuration options were: @ARGV";
if($#ARGV < 0) { print "(none)" };
print "\n\n";

if(-e $MKCONF_FILE) {
  print "The $GENIE/src/make/Make.config file has been succesfully generated! \n";
  print "The following config options were set: \n";

  open(MKCONFR, "<$MKCONF_FILE") or die("Can not read back the $GENIE/src/make/Make.config!");
  @make_conf=<MKCONFR>;
  close(MKCONFR);
# print "@make_conf\n" unless ;
  foreach $setting (@make_conf) { 
    chomp($setting); 
    if ($setting=~m/\=/) {print "  $setting\n";} 
  }

  print "\n";
  print "*** To continue building GENIE type: gmake ";
  # warning for SRT users  
  if(defined $ENV{'SRT_ENV_SET'}) {
    print "(Don't forget to 'srt_setup --unsetup' first)";
  }
  print "\n\n";

  exit 0;
}

sub auto_detect {

  @search_dir  = ("/usr","/opt","/lib");           # std search paths
  push (@search_dir,"$ENV{'HOME'}") 
                 if defined $ENV{'HOME'};          # add $HOME
  push (@search_dir,"/WorkApp");                   # add where I add ext apps in my MacBookPro
  push (@search_dir,"$ENV{'RSD_TOP_DIR'}") 
                 if defined $ENV{'RSD_TOP_DIR'};   # add where RSD puts ext supporting libs

  $search_file = shift; 
  foreach(@search_dir) {
     $curr_dir = $_;
     if(! -d $curr_dir) {next;}
     @matches = `find $curr_dir -type f -maxdepth 5 -name $search_file`;
     $nmatches = @matches;
     if( $nmatches > 0) { return $matches[0]; }
  }
  return "";
}
